services:
  controller:
    image: m2n2/telemitz-controller:latest
    restart: unless-stopped
    command: python main.py
    depends_on:
      - livekit
    environment:
      BACKEND_URL: "${BACKEND_URL}"
      REGISTRATION_TOKEN: "${REGISTRATION_TOKEN}"
      SELF_DOMAIN: "${SELF_DOMAIN}"
      LIVEKIT_API_KEY: "${LIVEKIT_API_KEY}"
      LIVEKIT_API_SECRET: "${LIVEKIT_API_SECRET}"

  nginx:
    build:
      dockerfile: nginx.Dockerfile
    restart: unless-stopped
    volumes:
      - ssl_data:/etc/resty-auto-ssl
      - cache_data:/var/cache/nginx/project_images_cache
    ports:
      - 80:80
      - 443:443

  livekit:
    image: livekit/livekit-server:latest
    restart: unless-stopped
    ports:
      - "7880:7880"
      - "7881:7881"
      - "50000-50500:50000-50500/udp"
    volumes:
      - ./livekit:/etc/livekit
    command: [ "--config", "/etc/livekit/config.yaml" ]

  filebeat:
    build:
      dockerfile: filebeat.Dockerfile
    hostname: ${HOSTNAME:-remote-server}
    restart: unless-stopped
    user: root
    environment:
      - ELASTICSEARCH_HOSTS=elastic_host
      - ELASTICSEARCH_API_KEY=elastic_api_key
    volumes:
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - filebeat_data:/usr/share/filebeat/data
    mem_limit: 256m

volumes:
  cache_data:
  ssl_data:
  onlogs-volume:
  filebeat_data:
